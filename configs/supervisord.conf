[supervisord]
nodaemon=true
logfile=/workspace/logs/supervisord.log
pidfile=/var/run/supervisord.pid

[unix_http_server]
file=/var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

; ===========================================================
; Core Infrastructure (priority 10)
; ===========================================================

[program:postgres]
command=/usr/lib/postgresql/16/bin/postgres -D /workspace/data/postgres
user=postgres
autostart=true
autorestart=true
priority=10
stdout_logfile=/workspace/logs/postgres/stdout.log
stderr_logfile=/workspace/logs/postgres/stderr.log

[program:nginx]
command=nginx -g "daemon off;" -c /workspace/config/nginx/nginx.conf
autostart=true
autorestart=true
priority=10
stdout_logfile=/workspace/logs/nginx/stdout.log
stderr_logfile=/workspace/logs/nginx/stderr.log

[program:sshd]
command=/usr/sbin/sshd -D
autostart=true
autorestart=true
priority=10

; ===========================================================
; N.eko Display Stack (priority 14-17)
; ===========================================================

[program:dbus]
command=dbus-daemon --system --nofork
autostart=true
autorestart=true
priority=14

[program:xvfb]
command=Xvfb :99 -screen 0 1920x1080x24
autostart=true
autorestart=true
priority=15

[program:pulseaudio]
command=pulseaudio --daemonize=no --exit-idle-time=-1
autostart=true
autorestart=true
priority=15

[program:openbox]
command=openbox
environment=DISPLAY=":99"
autostart=true
autorestart=true
priority=16

[program:chromium]
command=/usr/local/bin/chromium-pw --user-data-dir=/workspace/data/neko/chromium-profile --no-first-run --start-maximized --force-dark-mode --no-sandbox --disable-dev-shm-usage --disable-crash-reporter --disable-blink-features=AutomationControlled --use-gl=angle --use-angle=swiftshader --remote-debugging-port=9222 --remote-debugging-address=127.0.0.1 --remote-allow-origins=*
environment=DISPLAY=":99"
autostart=true
autorestart=true
priority=17
stdout_logfile=/workspace/logs/neko/chromium-stdout.log
stderr_logfile=/workspace/logs/neko/chromium-stderr.log

; ===========================================================
; Application Services (priority 30-50)
; ===========================================================

[program:synapse]
command=python3 -m synapse.app.homeserver --config-path=/workspace/config/synapse/homeserver.yaml
autostart=true
autorestart=true
priority=30
stdout_logfile=/workspace/logs/synapse/stdout.log
stderr_logfile=/workspace/logs/synapse/stderr.log

[program:chromadb]
command=chroma run --host 0.0.0.0 --port 8000 --path /workspace/data/chromadb
autostart=true
autorestart=true
priority=30
stdout_logfile=/workspace/logs/chromadb/stdout.log
stderr_logfile=/workspace/logs/chromadb/stderr.log

[program:ollama]
command=/usr/bin/ollama serve
environment=OLLAMA_HOST="0.0.0.0:11434",OLLAMA_MODELS="/workspace/data/ollama/models",OLLAMA_KEEP_ALIVE="24h"
autostart=true
autorestart=true
priority=30
stdout_logfile=/workspace/logs/ollama/stdout.log
stderr_logfile=/workspace/logs/ollama/stderr.log

[program:ttyd]
command=ttyd --port 7681 --writable --credential %(ENV_TTYD_USER)s:%(ENV_TTYD_PASSWORD)s /opt/conclave/scripts/tmux-workspace.sh
user=dev
directory=/workspace/data/coding/projects
environment=HOME="/workspace/data/coding"
autostart=true
autorestart=true
priority=30
stdout_logfile=/workspace/logs/ttyd/stdout.log
stderr_logfile=/workspace/logs/ttyd/stderr.log

[program:planka]
command=node /opt/planka/app.js
directory=/opt/planka
environment=NODE_ENV="production",PORT="1337"
autostart=true
autorestart=true
priority=40
stdout_logfile=/workspace/logs/planka/stdout.log
stderr_logfile=/workspace/logs/planka/stderr.log

[program:neko]
command=/usr/local/bin/neko serve
environment=DISPLAY=":99",NEKO_BIND="0.0.0.0:8080",NEKO_SCREEN="1920x1080@30",NEKO_EPR="52000-52100",NEKO_ICELITE="true"
autostart=true
autorestart=true
priority=50
stdout_logfile=/workspace/logs/neko/stdout.log
stderr_logfile=/workspace/logs/neko/stderr.log

; ===========================================================
; Post-Start Tasks (priority 99, oneshot)
; ===========================================================

[program:tmux-session]
command=/opt/conclave/scripts/tmux-session.sh
user=dev
directory=/workspace/data/coding/projects
environment=HOME="/workspace/data/coding"
autostart=true
autorestart=false
startsecs=0
exitcodes=0
priority=99
stdout_logfile=/workspace/logs/tmux-session.log
stderr_logfile=/workspace/logs/tmux-session-error.log

[program:ollama-pull]
command=/opt/conclave/scripts/ollama-pull.sh
autostart=true
autorestart=false
startsecs=0
exitcodes=0
priority=99
stdout_logfile=/workspace/logs/ollama/pull.log
stderr_logfile=/workspace/logs/ollama/pull-error.log

[program:create-users]
command=/opt/conclave/scripts/create-users.sh
autostart=true
autorestart=false
startsecs=0
exitcodes=0
priority=99
stdout_logfile=/workspace/logs/create-users.log
stderr_logfile=/workspace/logs/create-users-error.log
