---
- name: Install coding agent npm packages
  npm:
    name: "{{ item }}"
    global: true
  loop:
    - "@mariozechner/pi-coding-agent"
    - "@anthropic-ai/claude-code"
    - "@openai/codex"

- name: Install tmux
  apt:
    name: tmux
    state: present

- name: Install Python dependencies for pi-skills
  pip:
    name:
      - playwright
      - chromadb-client
      - httpx
      - websocket-client
      - Pillow
      - pyyaml

- name: Create pi assets directory
  file:
    path: /opt/conclave/pi/{{ item }}
    state: directory
  loop:
    - skills
    - extensions
    - prompts
    - themes

- name: Copy coding configs
  copy:
    src: "{{ conclave_configs_src }}/coding/{{ item }}"
    dest: "{{ conclave_configs_src }}/coding/{{ item }}"
    remote_src: true
  loop:
    - pi-models.json
    - pi-settings.json
    - tmux.conf

- name: Verify pi is installed
  command: pi --version
  changed_when: false

- name: Verify Claude Code is installed
  command: claude --version
  changed_when: false

- name: Verify Codex CLI is installed
  command: codex --version
  changed_when: false

- name: Verify pi skills are deployed
  stat:
    path: /opt/conclave/pi/skills
  register: pi_skills_dir
  failed_when: not pi_skills_dir.stat.exists
