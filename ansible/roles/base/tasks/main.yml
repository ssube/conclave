---
- name: Install base system packages
  apt:
    name:
      - supervisor
      - curl
      - wget
      - git
      - htop
      - vim
      - jq
      - ca-certificates
      - gettext-base
      - openssl
      - rsync
      - sudo
      - gnupg
      - lsb-release
      - tzdata
    state: present
    update_cache: true

- name: Add PostgreSQL APT repository key
  apt_key:
    url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
    state: present

- name: Add PostgreSQL APT repository
  apt_repository:
    repo: "deb http://apt.postgresql.org/pub/repos/apt {{ ansible_facts['distribution_release'] }}-pgdg main"
    state: present

- name: Add NodeSource GPG key
  apt_key:
    url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
    state: present

- name: Add NodeSource repository
  apt_repository:
    repo: "deb https://deb.nodesource.com/node_{{ conclave_node_version }}.x nodistro main"
    state: present

- name: Install Node.js
  apt:
    name: nodejs
    state: present
    update_cache: true

- name: Create interactive dev user
  user:
    name: "{{ conclave_dev_user }}"
    shell: /bin/bash
    home: /workspace/data/coding
    create_home: true
    groups: sudo
    password: "{{ conclave_dev_password | password_hash('sha512') }}"

- name: Create neko user
  user:
    name: neko
    shell: /bin/bash
    create_home: true

- name: Deploy supervisord config
  copy:
    src: "{{ conclave_configs_src }}/supervisord.conf"
    dest: /etc/supervisor/conf.d/conclave.conf
    remote_src: true

- name: Ensure supervisor socket directory exists
  file:
    path: /var/run
    state: directory
