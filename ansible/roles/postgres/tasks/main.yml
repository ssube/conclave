---
- name: Install PostgreSQL
  apt:
    name:
      - "postgresql-{{ conclave_postgres_version }}"
      - "postgresql-client-{{ conclave_postgres_version }}"
    state: present
    update_cache: true

- name: Drop default PostgreSQL cluster created by apt
  command: pg_dropcluster {{ conclave_postgres_version }} main --stop
  ignore_errors: true

- name: Ensure PostgreSQL unix socket directory
  file:
    path: /var/run/postgresql
    state: directory
    owner: postgres
    group: postgres

- name: Copy init-postgres script
  copy:
    src: "{{ conclave_scripts_dir }}/init-postgres.sh"
    dest: "{{ conclave_scripts_dir }}/init-postgres.sh"
    mode: "0755"
    remote_src: true

- name: Verify PostgreSQL is installed
  command: psql --version
  changed_when: false
